<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<window-config>
    <title>Explorer</title>
    <layout width="260" height="450" x="20" y="60" />
    <behavior draggable="true" overlay="false" />
    <controls minimize="true" close="true" />
</window-config>

<style>
    /* --- ESTRUCTURA GENERAL --- */
    .explorer-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: var(--bg-window);
        color: var(--text-main);
        font-family: var(--font-main);
        font-size: 13px;
        overflow: hidden;
        user-select: none;
        text-align: left;
    }

    .explorer-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        height: 35px;
        background-color: var(--bg-header);
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        flex-shrink: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-bottom: 1px solid var(--border-subtle);
    }

    .toolbar-actions {
        display: none;
    }

    .toolbar-actions .material-icons {
        font-size: 16px;
        cursor: pointer;
        margin-left: 6px;
        opacity: 0.7;
        color: var(--text-main);
    }

    .toolbar-actions .material-icons:hover {
        opacity: 1;
    }

    /* --- SCROLLBAR --- */
    .explorer-content {
        flex: 1;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .explorer-content::-webkit-scrollbar {
        width: 10px;
    }

    .explorer-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .explorer-content::-webkit-scrollbar-thumb {
        background-color: var(--bg-hover);
        border: 2px solid transparent;
        background-clip: content-box;
        border-radius: 10px;
    }

    .explorer-content:hover::-webkit-scrollbar-thumb {
        background-color: var(--border-subtle);
    }

    /* --- PLACEHOLDER --- */
    .drop-zone-container {
        display: flex;
        flex: 1;
        height: 100%;
        padding: 15px;
        box-sizing: border-box;
        overflow: hidden;
    }

    .drop-zone {
        width: 100%;
        height: 100%;
        border: 2px dashed var(--border-subtle);
        border-radius: var(--radius-main);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: var(--text-muted);
        transition: all 0.2s ease-out;
        cursor: pointer;
        background-color: var(--bg-input);
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
        border-color: var(--accent-color);
        background-color: var(--bg-hover);
        color: var(--text-main);
        transform: scale(0.99);
    }

    .drop-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.6;
    }

    .drop-text {
        font-size: 14px;
        line-height: 1.4;
        font-weight: 500;
        pointer-events: none;
        font-family: var(--font-main);
    }

    /* --- NUEVO BOTÓN --- */
    .or-divider {
        margin: 12px 0;
        font-size: 10px;
        color: var(--text-muted);
        opacity: 0.6;
        pointer-events: none;
    }

    .create-mod-btn {
        background-color: transparent;
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-family: var(--font-main);
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        transition: all 0.2s ease;
        pointer-events: auto;
        z-index: 10;
    }

    .create-mod-btn:hover {
        background-color: var(--accent-color);
        color: var(--accent-inverse);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    .create-mod-btn:active {
        transform: translateY(0);
    }

    /* --- ARBOL Y ITEMS --- */
    #treeRoot {
        display: none;
        padding-top: 5px;
        padding-bottom: 20px;
        width: 100%;
    }

    .tree-node {
        display: block;
        width: 100%;
    }

    .tree-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        text-align: left;
        width: 100%;
        box-sizing: border-box;
        cursor: pointer;
        padding-top: 3px;
        padding-bottom: 3px;
        padding-right: 10px;
        white-space: nowrap;
        border: 1px solid transparent;
        color: var(--text-main);
        position: relative;
    }

    /* Feedback visual Drag & Drop */
    .tree-item.drag-target-folder {
        background-color: var(--bg-hover) !important;
        outline: 1px dashed var(--accent-color);
    }

    .tree-item.folder:hover,
    .tree-item.file:hover {
        background-color: var(--bg-hover);
    }

    .tree-item.file.selected {
        background-color: var(--bg-hover);
        color: var(--accent-color);
        font-weight: bold;
    }

    .tree-arrow {
        font-size: 16px;
        color: var(--text-muted);
        width: 22px;
        min-width: 22px;
        height: 22px;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0.8;
        margin-right: 2px;
        transition: transform 0.1s ease-in-out;
        flex-shrink: 0;
    }

    .tree-node.open>.tree-item.folder .tree-arrow {
        transform: rotate(90deg);
    }

    .tree-spacer {
        width: 22px;
        min-width: 22px;
        height: 22px;
        margin-right: 2px;
        flex-shrink: 0;
        display: block;
    }

    .tree-icon {
        font-size: 16px;
        margin-right: 6px;
        color: var(--text-muted);
        flex-shrink: 0;
    }

    /* Colores Iconos */
    .icon-folder {
        color: #dcb67a;
    }

    .icon-js {
        color: #f1e05a;
    }

    .icon-json {
        color: #cbcb41;
    }

    .icon-html {
        color: #e34c26;
    }

    .icon-css {
        color: #563d7c;
    }

    .icon-img {
        color: #b07219;
    }

    .icon-default {
        color: var(--text-muted);
    }

    .tree-label {
        line-height: 18px;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
    }

    /* Input para renombrar */
    .rename-input {
        background: var(--bg-input);
        border: 1px solid var(--accent-color);
        color: var(--text-main);
        font-family: inherit;
        font-size: inherit;
        padding: 0 4px;
        outline: none;
        width: 100%;
        box-sizing: border-box;
        margin-left: -5px;
        border-radius: var(--radius-sm);
    }

    .tree-children {
        display: none;
        width: 100%;
    }

    .tree-node.open>.tree-children {
        display: block;
    }

    /* --- CONTEXT MENU --- */
    #contextMenu {
        display: none;
        position: fixed;
        background: var(--bg-header);
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-window);
        z-index: 10000;
        min-width: 150px;
        padding: 4px 0;
        border-radius: var(--radius-sm);
    }

    .ctx-item {
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-main);
    }

    .ctx-item:hover {
        background-color: var(--accent-color);
        color: var(--accent-inverse);
    }

    .ctx-separator {
        height: 1px;
        background-color: var(--border-subtle);
        margin: 4px 0;
    }
</style>

<div class="explorer-wrapper">
    <div class="explorer-toolbar">
        <span id="explorerTitle">EXPLORER</span>
        <div class="toolbar-actions" id="toolbarActions">
            <span class="material-icons" id="btnCollapse" title="Collapse All">unfold_less</span>
        </div>
    </div>

    <div class="explorer-content" id="explorerContent">
        <div class="drop-zone-container" id="placeholderContainer">
            <div class="drop-zone" id="fileDropArea">
                <span class="material-icons drop-icon">folder_open</span>
                <div class="drop-text">
                    Click to browse or drag your mod here
                </div>

                <div class="or-divider">- OR -</div>
                <button id="btnCreateMod" class="create-mod-btn">Create New Mod</button>

                <input type="file" id="fileInput" webkitdirectory directory multiple style="display: none;">
            </div>
        </div>

        <div id="treeRoot"></div>
    </div>
</div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxRename"><span class="material-icons" style="font-size:14px">edit</span> Rename</div>
    <div class="ctx-separator"></div>
    <div class="ctx-item" id="ctxDelete"><span class="material-icons" style="font-size:14px">delete</span> Delete</div>
</div>

<script>
    (function () {
        const placeholderContainer = document.getElementById('placeholderContainer');
        const dropZone = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');
        const treeRoot = document.getElementById('treeRoot');
        const btnCollapse = document.getElementById('btnCollapse');
        const explorerTitle = document.getElementById('explorerTitle');
        const toolbarActions = document.getElementById('toolbarActions');
        const contextMenu = document.getElementById('contextMenu');
        const btnCreateMod = document.getElementById('btnCreateMod');

        let globalFilesMap = {};
        let draggedItemPath = null;
        let contextTarget = null;

        const MOD_TEMPLATE_JSON = {
            "name": "Your mod name",
            "description": "Your mod description",
            "version": "1.0.0",
            "restart": false,
            "color": "#FF5500",
            "author": "Your name",
            "homepage": "https://yourmodhomepage.example",
            "dependencies": [],
            "api_version": "1.0"
        };

        const DEFAULT_FOLDERS = [
            'songs', 'data', 'data/characters', 'data/stages', 'images', 'images/characters', 'music', 'sounds'
        ];

        // --- EVENTOS DE UI ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });

        if (btnCreateMod) {
            btnCreateMod.addEventListener('click', (e) => {
                e.stopPropagation();
                createModStructure();
            });
        }

        // --- CREACIÓN DE MOD ---
        function createModStructure() {
            globalFilesMap = {};
            const jsonContent = JSON.stringify(MOD_TEMPLATE_JSON, null, 4);
            const jsonFile = new File([jsonContent], "mod.json", { type: "application/json" });
            globalFilesMap["mod.json"] = jsonFile;

            DEFAULT_FOLDERS.forEach(folderPath => {
                const keepFile = new File([""], ".keep", { type: "text/plain" });
                globalFilesMap[`${folderPath}/.keep`] = keepFile;
            });

            console.log("Mod structure created in memory.");
            refreshTree();
        }

        // --- MANEJO DE ARCHIVOS (DROP & INPUT) ---
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const items = e.dataTransfer.items;
            if (!items) return;

            const entry = items[0].webkitGetAsEntry();
            globalFilesMap = {};

            if (entry && entry.isFile && entry.name.endsWith('.zip')) {
                const file = items[0].getAsFile();
                await processZip(file, globalFilesMap);
            } else if (entry) {
                await scanFiles(entry, globalFilesMap);
            }
            refreshTree();
        });

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            globalFilesMap = {};
            files.forEach(f => globalFilesMap[f.webkitRelativePath || f.name] = f);
            refreshTree();
        });

        // --- CONTEXT MENU ---
        window.addEventListener('click', () => contextMenu.style.display = 'none');
        document.getElementById('ctxRename').addEventListener('click', () => { if (contextTarget) startRename(contextTarget); });
        document.getElementById('ctxDelete').addEventListener('click', () => {
            if (contextTarget) {
                const keysToDelete = Object.keys(globalFilesMap).filter(k => k === contextTarget || k.startsWith(contextTarget + '/'));
                keysToDelete.forEach(k => delete globalFilesMap[k]);
                refreshTree();
            }
        });

        function startRename(path) {
            const treeItem = document.querySelector(`.tree-item[data-path="${path}"]`);
            if (!treeItem) return;
            const label = treeItem.querySelector('.tree-label');
            const oldName = label.textContent;
            const input = document.createElement('input');
            input.type = 'text'; input.value = oldName; input.className = 'rename-input';
            label.style.display = 'none'; treeItem.appendChild(input); input.focus(); input.select();

            const commit = () => {
                const newName = input.value.trim();
                if (newName && newName !== oldName) performRename(path, newName);
                else cancel();
            };
            const cancel = () => { input.remove(); label.style.display = 'block'; };
            input.addEventListener('blur', commit);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); else if (e.key === 'Escape') { input.removeEventListener('blur', commit); cancel(); } });
            input.addEventListener('mousedown', (e) => e.stopPropagation());
        }

        function performRename(oldPath, newName) {
            const parts = oldPath.split('/'); parts.pop();
            const basePath = parts.join('/');
            const newPathStart = basePath ? `${basePath}/${newName}` : newName;
            const newMap = {};
            Object.keys(globalFilesMap).forEach(key => {
                if (key === oldPath || key.startsWith(oldPath + '/')) {
                    const suffix = key.substring(oldPath.length);
                    const newKey = newPathStart + suffix;
                    newMap[newKey] = globalFilesMap[key];
                } else { newMap[key] = globalFilesMap[key]; }
            });
            globalFilesMap = newMap; refreshTree();
        }

        // --- DRAG INTERNO ---
        function handleDragStart(e, path) {
            e.stopPropagation(); draggedItemPath = path;
            e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', path);
        }

        function handleDragOver(e, isFolder, targetPath) {
            e.preventDefault(); e.stopPropagation();
            if (isFolder && draggedItemPath !== targetPath && !targetPath.startsWith(draggedItemPath + '/')) {
                e.currentTarget.classList.add('drag-target-folder'); e.dataTransfer.dropEffect = 'move';
            } else { e.dataTransfer.dropEffect = 'none'; }
        }

        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-target-folder'); }
        function handleDrop(e, targetPath) {
            e.preventDefault(); e.stopPropagation();
            e.currentTarget.classList.remove('drag-target-folder');
            if (!draggedItemPath || draggedItemPath === targetPath) return;
            performMove(draggedItemPath, targetPath); draggedItemPath = null;
        }

        function performMove(sourcePath, targetFolder) {
            const sourceName = sourcePath.split('/').pop();
            const newPrefix = targetFolder ? `${targetFolder}/${sourceName}` : sourceName;
            const newMap = {};
            Object.keys(globalFilesMap).forEach(key => {
                if (key === sourcePath || key.startsWith(sourcePath + '/')) {
                    const relativeSuffix = key.substring(sourcePath.length);
                    const newKey = newPrefix + relativeSuffix;
                    newMap[newKey] = globalFilesMap[key];
                } else { newMap[key] = globalFilesMap[key]; }
            });
            globalFilesMap = newMap; refreshTree();
        }

        // --- RENDERIZADO DEL ÁRBOL ---
        function refreshTree() {
            if (Object.keys(globalFilesMap).length > 0) {
                placeholderContainer.style.display = 'none';
                treeRoot.style.display = 'block';
                toolbarActions.style.display = 'block';
                treeRoot.innerHTML = '';
                const treeStructure = buildTreeFromPaths(Object.keys(globalFilesMap));
                const rootKeys = Object.keys(treeStructure);
                if (rootKeys.length === 1 && !treeStructure[rootKeys[0]].isFile && rootKeys[0] !== 'mod.json') {
                    const rootNode = treeStructure[rootKeys[0]];
                    explorerTitle.textContent = rootNode.name.toUpperCase();
                    renderTree(rootNode.children, treeRoot, 0, rootNode.name);
                } else {
                    explorerTitle.textContent = "EXPLORER";
                    renderTree(treeStructure, treeRoot, 0, "");
                }
            }
        }

        function renderTree(nodeList, container, level, currentPathPrefix) {
            const keys = Object.keys(nodeList).sort((a, b) => {
                const nodeA = nodeList[a]; const nodeB = nodeList[b];
                if (nodeA.isFile === nodeB.isFile) return a.localeCompare(b);
                return nodeA.isFile ? 1 : -1;
            });

            keys.forEach(key => {
                const node = nodeList[key];
                if (node.name === '.keep') return;
                const wrapper = document.createElement('div'); wrapper.className = 'tree-node';
                const fullPath = currentPathPrefix ? `${currentPathPrefix}/${node.name}` : node.name;
                const itemRow = document.createElement('div'); itemRow.className = 'tree-item';
                itemRow.dataset.path = fullPath; itemRow.draggable = true;
                itemRow.addEventListener('dragstart', (e) => handleDragStart(e, fullPath));

                if (node.isFile) itemRow.classList.add('file');
                else {
                    itemRow.classList.add('folder');
                    itemRow.addEventListener('dragover', (e) => handleDragOver(e, true, fullPath));
                    itemRow.addEventListener('dragleave', handleDragLeave);
                    itemRow.addEventListener('drop', (e) => handleDrop(e, fullPath));
                }

                itemRow.style.paddingLeft = `${level * 14 + 10}px`;

                itemRow.addEventListener('contextmenu', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    contextTarget = fullPath;
                    contextMenu.style.left = `${e.clientX}px`; contextMenu.style.top = `${e.clientY}px`;
                    contextMenu.style.display = 'block';
                });

                if (!node.isFile) {
                    const arrow = document.createElement('span'); arrow.className = 'material-icons tree-arrow'; arrow.textContent = 'chevron_right';
                    itemRow.appendChild(arrow);
                    itemRow.addEventListener('click', (e) => { e.stopPropagation(); wrapper.classList.toggle('open'); });
                } else {
                    const spacer = document.createElement('span'); spacer.className = 'tree-spacer'; itemRow.appendChild(spacer);
                    itemRow.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.tree-item.file').forEach(el => el.classList.remove('selected'));
                        itemRow.classList.add('selected');
                        console.log("Seleccionado:", fullPath);

                        // [NUEVO] Lógica de lectura segura
                        if (node.isFile && node.name.toLowerCase().endsWith('.json')) {
                            const entry = globalFilesMap[fullPath];

                            // Usamos el helper readFileContent para soportar todos los formatos
                            readFileContent(entry)
                                .then(text => {
                                    try {
                                        const content = JSON.parse(text);
                                        // Verificar si contiene "stage" y es un array
                                        if (content && content.stage && Array.isArray(content.stage)) {
                                            console.log("Stage seleccionado para editar:", fullPath);
                                            window.dispatchEvent(new CustomEvent('editor-stage-selected', {
                                                detail: { stageData: content, path: fullPath }
                                            }));
                                        }
                                    } catch (err) {
                                        console.warn("Error parseando JSON:", err);
                                    }
                                })
                                .catch(err => console.error("Error leyendo archivo:", err));
                        }
                    });
                }

                const icon = document.createElement('span'); icon.className = 'material-icons tree-icon';
                const iconData = getIconForFile(node.name, node.isFile);
                icon.textContent = iconData.icon; icon.classList.add(iconData.class);
                itemRow.appendChild(icon);

                const label = document.createElement('span'); label.className = 'tree-label'; label.textContent = node.name;
                itemRow.appendChild(label);
                wrapper.appendChild(itemRow);

                if (!node.isFile) {
                    const childrenContainer = document.createElement('div'); childrenContainer.className = 'tree-children';
                    renderTree(node.children, childrenContainer, level + 1, fullPath);
                    wrapper.appendChild(childrenContainer);
                }
                container.appendChild(wrapper);
            });
        }

        // --- HELPER UNIVERSAL DE LECTURA ---
        function readFileContent(entry) {
            return new Promise((resolve, reject) => {
                // Caso 1: File Object (Input o Create Mod)
                if (entry instanceof File) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(entry);
                }
                // Caso 2: JSZip Object (Zip Drop)
                else if (entry.async) {
                    entry.async("string").then(resolve).catch(reject);
                }
                // Caso 3: FileSystemFileEntry (Folder Drop)
                else if (entry.isFile && entry.file) {
                    entry.file((file) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsText(file);
                    }, reject);
                }
                else {
                    reject("Tipo de archivo desconocido");
                }
            });
        }

        // --- PROCESAMIENTO DE ARCHIVOS ---
        async function processZip(file, map) {
            if (!window.JSZip) return console.error("JSZip missing");
            const zip = await JSZip.loadAsync(file);
            zip.forEach((relativePath, zipEntry) => {
                if (!zipEntry.dir) map[relativePath] = zipEntry; // GUARDAMOS EL OBJETO ZIP, NO STRING
            });
        }

        async function scanFiles(entry, map) {
            if (entry.isFile) {
                let cleanPath = entry.fullPath; if (cleanPath.startsWith('/')) cleanPath = cleanPath.substring(1);
                map[cleanPath] = entry;
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader(); const entries = await readAllEntries(dirReader);
                for (const child of entries) await scanFiles(child, map);
            }
        }
        function readAllEntries(dirReader) {
            return new Promise((resolve) => {
                let entries = [];
                const read = () => { dirReader.readEntries(result => { if (!result.length) resolve(entries); else { entries = entries.concat(result); read(); } }); };
                read();
            });
        }

        // --- UTILS ---
        function buildTreeFromPaths(paths) {
            const root = {};
            paths.forEach(path => {
                const parts = path.split('/'); let current = root;
                parts.forEach((part, index) => {
                    if (!current[part]) current[part] = { name: part, children: {}, isFile: index === parts.length - 1 };
                    current = current[part].children;
                });
            });
            return root;
        }
        function getIconForFile(filename, isFile) {
            if (!isFile) return { icon: 'folder', class: 'icon-folder' };
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'js': return { icon: 'description', class: 'icon-js' };
                case 'json': return { icon: 'data_object', class: 'icon-json' };
                case 'html': return { icon: 'code', class: 'icon-html' };
                case 'css': return { icon: 'style', class: 'icon-css' };
                case 'png': case 'jpg': return { icon: 'image', class: 'icon-img' };
                case 'md': return { icon: 'info', class: 'icon-default' };
                default: return { icon: 'insert_drive_file', class: 'icon-default' };
            }
        }
        btnCollapse.addEventListener('click', () => { document.querySelectorAll('.tree-node.open').forEach(n => n.classList.remove('open')); });
    })();
</script>